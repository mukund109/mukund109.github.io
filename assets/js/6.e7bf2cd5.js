(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{268:function(a,t,s){"use strict";s.r(t);var n=s(38),e=Object(n.a)({},function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"scala-map-serialization"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#scala-map-serialization","aria-hidden":"true"}},[a._v("#")]),a._v(" Scala Map serialization")]),a._v(" "),s("p",[a._v("Ran into a bug today while trying to run a spark job that used a Scala Map to filter out some values from a Spark RDD.")]),a._v(" "),s("div",{staticClass:"language-scala extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scala"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("val")]),a._v(" myMap "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" Map"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"foo"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("->")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"bar"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("->")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("4")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("mapValues"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v(" _ "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\nrdd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("filter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v(" myMap"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("_"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("5")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// throws serialization error")]),a._v("\n")])])]),s("p",[a._v("The code worked if I didn't use "),s("code",[a._v("mapValues")])]),a._v(" "),s("div",{staticClass:"language-scala extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scala"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("val")]),a._v(" myMap "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" Map"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"foo"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("->")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("4")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"bar"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("->")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("8")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\nrdd"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("filter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v(" myMap"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("_"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("5")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// runs ")]),a._v("\n")])])]),s("p",[a._v("It turns out that "),s("code",[a._v("mapValues")]),a._v(" is evaluated lazily. It returns a "),s("a",{attrs:{href:"https://github.com/scala/scala/blob/05016d9035ab9b1c866bd9f12fdd0491f1ea0cbb/src/library/scala/collection/MapLike.scala#L265",target:"_blank",rel:"noopener noreferrer"}},[a._v("wrapper"),s("OutboundLink")],1),a._v(" around the original "),s("code",[a._v("Map")]),a._v(".")]),a._v(" "),s("div",{staticClass:"language-scala extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scala"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// scala Map implementation")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("def")]),a._v(" mapValues"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("W"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("f"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" V "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("=>")]),a._v(" W"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" Map"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("K"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" W"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("new")]),a._v(" MappedValues"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("f"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("protected")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("class")]),a._v(" MappedValues"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("W"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("f"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" V "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("=>")]),a._v(" W"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("extends")]),a._v(" AbstractMap"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("K"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" W"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("with")]),a._v(" DefaultMap"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("K"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" W"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("def")]),a._v(" get"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("key"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(":")]),a._v(" K"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("self")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("get"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("map"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("f"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])])]),s("p",[a._v("The class "),s("code",[a._v("MappedValues")]),a._v(" isn't serializable, which caused the bug.")]),a._v(" "),s("p",[a._v("Moreoever, "),s("code",[a._v("f")]),a._v(" is called everytime a value is requested, which might be a problem if "),s("code",[a._v("f")]),a._v(" is expensive.")]),a._v(" "),s("p",[a._v("One workaround for this is to force its evaluation:")]),a._v(" "),s("div",{staticClass:"language-scala extra-class"},[s("pre",{pre:!0,attrs:{class:"language-scala"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("val")]),a._v(" myMap "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" Map"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"foo"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("->")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"bar"')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("->")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("4")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("mapValues"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v(" _ "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("*")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("val")]),a._v(" forcedMap "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" myMap"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("map"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("_"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n")])])]),s("p",[a._v("There does seem to be some progress in finding a "),s("a",{attrs:{href:"https://github.com/scala/scala/pull/6676#issue-190110470",target:"_blank",rel:"noopener noreferrer"}},[a._v("fix"),s("OutboundLink")],1),a._v(" for this in Scala 2.13.x .")])])},[],!1,null,null,null);t.default=e.exports}}]);